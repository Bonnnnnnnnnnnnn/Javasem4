
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<link rel="stylesheet" th:href="@{/css/pagination.css}">
<div th:replace="businessManager/layout/header_admin"></div>
<div class="content-wrapper" style="min-height: 1302.4px;">
	<!-- Content Header (Page header) -->
	<section class="content-header">
		<div class="container-fluid">
			<div class="row mb-2">
				<div class="col-sm-6">
					<h1>Lis</h1>
				</div>
				<div class="col-sm-6">
					<ol class="breadcrumb float-sm-right">
						<li class="breadcrumb-item"><a href="#">Home</a></li>
						<li class="breadcrumb-item active">Reply comment</li>
					</ol>
				</div>
			</div>
		</div>
		<!-- /.container-fluid -->
	</section>

	<!-- Main content -->
	<section class="content">
		<div class="chat-container">
			<!-- Left Sidebar - Chat List -->
			<div class="chat-sidebar">
				<div class="chat-list-header">
					<h5>Chat Messages</h5>
				</div>

				<!-- List of chat rooms -->
				<div class="chat-list">
    <div th:each="chat : ${chatRooms}" 
         class="chat-list-item"
         th:data-chat-id="${chat.id}"
         th:classappend="${chat.id == activeChat?.id ? 'active' : ''}"
         th:onclick="'openChat(' + ${chat.id} + ')'">
        <div class="chat-item-content">
            <div class="chat-item-title">
                <span class="order-id">Order #[[${chat.orderId}]]</span> 
                <span class="chat-time"
                      th:text="${chat.lastActivity}">
                </span>
            </div>
            <div class="chat-item-preview"
                 th:text="${chat.lastMessage ?: 'No messages yet...'}">
            </div>
        </div>
    </div>
</div>
			</div>

			<!-- Right Side - Chat Window -->
			<div class="chat-main">
				<!-- Chat Header -->
				<div class="chat-header">
					<div class="chat-header-info">
						<h6 class="mb-0" th:if="${activeChat}">Order
							#[[${activeChat.orderId}]]</h6>
						<span class="status-text">Active</span>
					</div>
				</div>

				<!-- Chat Messages Area -->
				<div class="chat-messages" id="chatMessages">
					<!-- Messages will be loaded here -->
				</div>

				<!-- Chat Input -->
				<div class="chat-input">
    <div class="input-group">
        <input type="text" id="messageInput" class="form-control" placeholder="Type a message...">
        <div class="input-group-append">
            <button class="btn btn-primary" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
			</div>
		</div>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		<style>
.chat-container {
	display: flex;
	height: 80vh;
	background: #fff;
	border-radius: 8px;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Left Sidebar Styles */
.chat-sidebar {
	width: 300px;
	border-right: 1px solid #e0e0e0;
	display: flex;
	flex-direction: column;
}

.chat-list-header {
	padding: 15px;
	border-bottom: 1px solid #e0e0e0;
}

.chat-list {
	overflow-y: auto;
	flex: 1;
}

.chat-list-item {
	padding: 12px 15px;
	border-bottom: 1px solid #f0f0f0;
	cursor: pointer;
	transition: all 0.2s;
}

.chat-list-item:hover {
	background: #f8f9fa;
}

.chat-list-item.active {
	background: #e3f2fd;
}

.chat-item-title {
	display: flex;
	justify-content: space-between;
	margin-bottom: 5px;
}

.chat-time {
	font-size: 0.8rem;
	color: #666;
}

.chat-item-preview {
	font-size: 0.9rem;
	color: #666;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}

/* Right Side Chat Window Styles */
.chat-main {
	flex: 1;
	display: flex;
	flex-direction: column;
}

.chat-header {
	padding: 15px;
	border-bottom: 1px solid #e0e0e0;
	background: #f8f9fa;
}

.chat-messages {
	flex: 1;
	overflow-y: auto;
	padding: 15px;
	background: #f5f5f5;
}

.chat-input {
	padding: 15px;
	border-top: 1px solid #e0e0e0;
	background: #fff;
}

.chat-input .form-control {
	border-radius: 20px;
	padding: 8px 15px;
}

.chat-input .btn {
	border-radius: 20px;
	padding: 8px 15px;
	margin-left: 10px;
}

/* Message Bubbles */
.message {
	margin-bottom: 10px;
	max-width: 70%;
}

.message-customer {
	margin-right: auto;
}

.message-employee {
	margin-left: auto;
}

.message-content {
	padding: 10px 15px;
	border-radius: 15px;
	background: #fff;
	box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.message-employee .message-content {
	background: #007bff;
	color: #fff;
}
</style>

		<script>
		let stompClient = null;
		let currentChatId = null;
		let currentSubscription = null;

    // Kết nối WebSocket khi trang được load
    function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    
    stompClient.connect({}, 
        function(frame) {
            console.log('Connected to WebSocket from employee');
            if (currentChatId) {
                subscribeToRoom(currentChatId);
            }
        },
        function(error) {
            console.error('WebSocket connection error:', error);
            // Thử kết nối lại sau 3 giây
            setTimeout(connectWebSocket, 3000);
        }
    );
}

    function openChat(chatId) {
        currentChatId = chatId;
        
        
        $('.chat-list-item').removeClass('active');
        $(`[data-chat-id="${chatId}"]`).addClass('active');
        
        
        $.ajax({
            url: `/support/messages/${chatId}`,
            method: 'GET',
            success: function(messages) {
                displayMessages(messages);
                
                
                subscribeToRoom(chatId);
                
                
                markMessagesAsRead(chatId);
            },
            error: function(xhr) {
                toastr.error('Error loading chat messages');
            }
        });
    }

    function displayMessages(messages) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        
        messages.forEach(message => {
            const isEmployee = message.senderType === 'EMPLOYEE';
            const messageHtml = `
                <div class="message ${isEmployee ? 'message-employee' : 'message-customer'}">
                    <div class="message-content">
                        ${message.message}
                    </div>
                    <div class="message-time">
                        ${formatTimestamp(message.timestamp)}
                    </div>
                </div>
            `;
            chatMessages.innerHTML += messageHtml;
        });
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function subscribeToRoom(chatId) {
        if (!stompClient) {
            console.error('WebSocket not initialized');
            connectWebSocket();
            return;
        }
        
        if (!stompClient.connected) {
            console.error('WebSocket not connected');
            setTimeout(() => subscribeToRoom(chatId), 1000);
            return;
        }

        if (currentSubscription) {
            currentSubscription.unsubscribe();
        }
        
        currentSubscription = stompClient.subscribe('/topic/chat/' + chatId, function(response) {
            try {
                const message = JSON.parse(response.body);
                appendMessage(message);
                // Cập nhật số tin nhắn chưa đọc
                if (message.senderType === 'CUSTOMER') {
                    updateUnreadCount();
                }
            } catch (error) {
                console.error('Error parsing message:', error);
            }
        });
    }

    function markMessagesAsRead(chatId) {
        $.ajax({
            url: `/support/mark-read/${chatId}`,
            method: 'POST',
            success: function() {
                // Update unread count if needed
                updateUnreadCount();
            }
        });
    }
    function updateUnreadCount() {
        $.ajax({
            url: '/support/unread-count',
            method: 'GET',
            success: function(count) {
                const badge = $('.unread-badge');
                if (badge.length) {
                    badge.text(count);
                    if (count > 0) {
                        badge.show();
                    } else {
                        badge.hide();
                    }
                }
            }
        });
    }
    // Thêm message mới vào chat window
    function appendMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const isEmployee = message.senderType === 'EMPLOYEE';
    
    const messageHtml = `
        <div class="message ${isEmployee ? 'message-employee' : 'message-customer'}">
            <div class="message-content">
                ${message.message}
            </div>
            <div class="message-time">
                ${formatTimestamp(message.timestamp)}
            </div>
        </div>
    `;
    
    chatMessages.insertAdjacentHTML('beforeend', messageHtml);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

    // Connect WebSocket khi page load
    $(document).ready(function() {
        connectWebSocket();
    });
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();
        
        if (content && currentChatId && stompClient && stompClient.connected) {
            const message = {
                chatroomId: currentChatId,
                message: content,
                senderType: 'EMPLOYEE'
            };
            
            stompClient.send("/app/chat/send/" + currentChatId, {}, JSON.stringify(message));
            messageInput.value = '';
        }
    }

    $(document).ready(function() {
        connectWebSocket();
        updateUnreadCount(); // Cập nhật số tin nhắn chưa đọc khi load trang
    });
    $(window).on('beforeunload', function() {
        if (stompClient) {
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }
            stompClient.disconnect();
        }
    });
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    </script>
	</section>
</div>
<script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.js"></script>
<div th:replace="businessManager/layout/footer_admin"></div>
</html>

